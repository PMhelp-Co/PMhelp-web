<!DOCTYPE html>
<html lang="en" data-wf-site="66bfc83501d1faf8dbade3d5">
<head>
  <meta charset="utf-8">
  <title>Sign Up - PMHelp</title>
  <meta content="Create your PMHelp account" name="description">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="css/tailwind-auth.css" rel="stylesheet" type="text/css">
  <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.png" rel="apple-touch-icon">
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-config.js"></script>
  <script src="js/auth.js"></script>
  <style>
    .shadow-soft {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .shadow-soft-lg {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }
    input:focus {
      outline: none;
      border-color: #7e22ce;
      box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.1);
    }
    a.cursor-pointer {
      transition: opacity 0.2s;
    }
    a.cursor-pointer:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
  
  <div class="w-full max-w-md space-y-8">
    
    <!-- Logo and Header -->
    <div class="flex flex-col items-center">
      <a href="index.html" class="cursor-pointer">
        <img src="images/simple logo.png" alt="PMhelp Logo" class="h-12 w-auto mb-8">
      </a>
      <h2 class="mt-2 mb-0 text-center text-3xl font-bold tracking-tight text-gray-900">Create an account</h2>
      <p class="mt-2 mb-0 text-center text-sm text-gray-600">Join to start learning today</p>
    </div>

    <!-- Google Sign In Button -->
    <button
      id="google-signup"
      type="button"
      class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-all duration-200 ease-friendly focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 shadow-soft hover:shadow-soft-lg hover:scale-[1.02] active:scale-[0.98] border-2 border-gray-300 bg-white hover:bg-gray-50 hover:border-purple-300 h-11 px-5 py-2.5 w-full rounded-full">
      <svg stroke="currentColor" fill="currentColor" stroke-width="0" version="1.1" x="0px" y="0px" viewBox="0 0 48 48" enable-background="new 0 0 48 48" class="mr-2 h-5 w-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
        <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12
          c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24
          c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
        <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657
          C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
        <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36
          c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
        <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571
          c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
      </svg>
      Continue with Google
    </button>

    <!-- Divider -->
    <div class="relative my-6">
      <div class="shrink-0 bg-gray-300 h-[1px] w-full"></div>
      <div class="absolute inset-0 flex items-center justify-center">
        <span class="bg-gray-50 px-4 text-sm text-gray-500">Or continue with email</span>
      </div>
    </div>

    <!-- Error/Success Message -->
    <div id="message" class="hidden text-sm text-center p-3 rounded-lg"></div>
    
    <!-- Spam Folder Reminder (shown after successful signup) -->
    <div id="spam-reminder" class="hidden mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
      <div class="flex items-start">
        <svg class="h-5 w-5 text-amber-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <p class="text-sm font-medium text-amber-800">ðŸ“¬ Check your spam folder</p>
          <p class="text-sm text-amber-700 mt-1">Our verification emails sometimes land in spam or promotions. If you don't see it in your inbox, please check those folders and mark us as "Not Spam" so you don't miss future updates.</p>
        </div>
      </div>
    </div>

    <!-- Sign Up Form -->
    <form id="signup-form" class="mt-8 space-y-4">
      <div>
        <input
          id="full_name"
          type="text"
          placeholder="Full Name"
          class="flex h-11 w-full border-2 border-gray-300 bg-white px-4 py-2.5 text-base ring-offset-background placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2 focus-visible:border-purple-500 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-200 md:text-sm rounded-full"
          required>
      </div>
      
      <div>
        <input
          id="email"
          type="email"
          placeholder="Email address"
          class="flex h-11 w-full border-2 border-gray-300 bg-white px-4 py-2.5 text-base ring-offset-background placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2 focus-visible:border-purple-500 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-200 md:text-sm rounded-full"
          required>
      </div>
      
      <div style="position: relative;">
        <input
          id="password"
          type="password"
          placeholder="Password"
          class="flex h-11 w-full border-2 border-gray-300 bg-white px-4 py-2.5 pr-12 text-base ring-offset-background placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2 focus-visible:border-purple-500 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-200 md:text-sm rounded-full"
          required
          minlength="6">
      </div>
      
      <div>
        <button
          type="submit"
          id="signup-button"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-all duration-200 ease-friendly focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 shadow-soft hover:shadow-soft-lg hover:scale-[1.02] active:scale-[0.98] bg-primary hover:bg-primary/90 text-white h-11 px-5 py-2.5 w-full rounded-full bg-gradient-to-r from-[#7e22ce] to-[#9333ea] hover:from-[#6b21a8] hover:to-[#7e22ce]">
          Sign Up
        </button>
      </div>
    </form>

    <p class="mt-4 text-center text-sm text-gray-600">
      Already have an account? 
      <a href="signin.html" class="font-medium text-[#4C1D95] hover:text-[#3B1674]">Sign in</a>
    </p>

  </div>

  <!-- Auth Script -->
  <script src="js/utils/password-toggle.js"></script>
  <script src="js/pages/signup-page.js"></script>
  
  <!-- Handle OAuth callback and auto-link password -->
  <script>
    // Handle OAuth callback from URL hash and auto-link password if pending
    (async function handleOAuthCallbackAndLinkPassword() {
      // Check if we have a pending password to link
      const pendingPasswordData = sessionStorage.getItem('pending_password_link');
      const urlParams = new URLSearchParams(window.location.search);
      const autoLinkPassword = urlParams.get('autoLinkPassword') === 'true';
      
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/46e91860-3131-4ee5-9172-bd43e7c7305a',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'signup.html:OAuth callback handler',message:'Checking for OAuth callback and pending password',data:{hasPendingPassword:!!pendingPasswordData,autoLinkPassword,hasHash:!!window.location.hash},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H86'})}).catch(()=>{});
      // #endregion
      
      if (pendingPasswordData && autoLinkPassword) {
        // Wait for Supabase and Auth to be ready
        let retries = 0;
        while ((!window.supabaseClient || !window.Auth) && retries < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }
        
        if (window.supabaseClient && window.Auth) {
          // Wait for OAuth session to be established
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          // Check if user is now signed in
          const { data: { user }, error: getUserError } = await window.supabaseClient.auth.getUser();
          
          // #region agent log
          fetch('http://127.0.0.1:7242/ingest/46e91860-3131-4ee5-9172-bd43e7c7305a',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'signup.html:OAuth callback handler',message:'Checking if user signed in after OAuth',data:{hasUser:!!user,userEmail:user?.email,hasError:!!getUserError},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H87'})}).catch(()=>{});
          // #endregion
          
          if (user && !getUserError) {
            try {
              const pendingData = JSON.parse(pendingPasswordData);
              
              // Verify email matches
              if (user.email?.toLowerCase() === pendingData.email.toLowerCase()) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/46e91860-3131-4ee5-9172-bd43e7c7305a',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'signup.html:OAuth callback handler',message:'Linking password to OAuth account',data:{userId:user.id,email:user.email},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H88'})}).catch(()=>{});
                // #endregion
                
                // Link password to OAuth account
                const { data: updateData, error: updateError } = await window.supabaseClient.auth.updateUser({
                  password: pendingData.password
                });
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/46e91860-3131-4ee5-9172-bd43e7c7305a',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'signup.html:OAuth callback handler',message:'Password link result',data:{hasError:!!updateError,errorMessage:updateError?.message,hasUser:!!updateData?.user},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H89'})}).catch(()=>{});
                // #endregion
                
                if (!updateError && updateData.user) {
                  // Update profile if metadata provided
                  if (pendingData.metadata?.full_name) {
                    await window.Auth.updateProfile(updateData.user.id, { full_name: pendingData.metadata.full_name });
                  }
                  
                  // Clear pending password data
                  sessionStorage.removeItem('pending_password_link');
                  
                  // Clear OAuth conflict cache since password is now linked
                  const cacheKey = `oauth_conflict_${pendingData.email.toLowerCase()}`;
                  sessionStorage.removeItem(cacheKey);
                  
                  // #region agent log
                  fetch('http://127.0.0.1:7242/ingest/46e91860-3131-4ee5-9172-bd43e7c7305a',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'signup.html:OAuth callback handler',message:'Password linked successfully, redirecting',data:{userId:updateData.user.id},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H90'})}).catch(()=>{});
                  // #endregion
                  
                  // Show success message and redirect
                  const messageDiv = document.getElementById('message');
                  if (messageDiv) {
                    messageDiv.textContent = 'Password linked successfully! You can now sign in with either Google or email/password.';
                    messageDiv.className = 'text-sm text-center p-3 rounded-lg bg-green-100 text-green-700';
                    messageDiv.classList.remove('hidden');
                  }
                  
                  // Clean up URL
                  window.history.replaceState(null, null, window.location.pathname);
                  
                  // Redirect to home after 2 seconds
                  setTimeout(() => {
                    window.location.href = 'index.html';
                  }, 2000);
                } else {
                  console.error('Failed to link password:', updateError);
                  sessionStorage.removeItem('pending_password_link');
                }
              } else {
                console.error('Email mismatch:', user.email, pendingData.email);
                sessionStorage.removeItem('pending_password_link');
              }
            } catch (parseError) {
              console.error('Error parsing pending password data:', parseError);
              sessionStorage.removeItem('pending_password_link');
            }
          }
        }
      } else if (window.location.hash && window.location.hash.includes('access_token')) {
        // Normal OAuth callback - just clean up URL
        setTimeout(() => {
          window.history.replaceState(null, null, window.location.pathname);
        }, 1000);
      }
    })();
  </script>
</body>
</html>

